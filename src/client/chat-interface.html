<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>iXat Chat Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        @keyframes powerEffect {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #ffffff;
            overflow-x: hidden;
        }

        .table {
            display: table;
            width: 100%;
            height: 100%;
            table-layout: fixed;
            max-width: 100%;
            max-height: 100%;
            overflow: hidden;
        }
        
        .row {
            display: table-row;
        }
        
        .cell {
            display: table-cell;
            vertical-align: top;
            padding: 0;
            margin: 0;
        }
        
        .background {
            width: 100%;
            height: 100%;
            background-size: 100% 100%;
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .tab {
            overflow: hidden;
            width: 100%;
            height: 100%;
        }
        
        .tab button {
            background-color: rgba(255,255,255,.4);
            border: none;
            outline: 0;
            cursor: pointer;
            padding-left: .2rem;
            font-size: .85rem;
            border-top: 1px solid rgba(192,192,192,.8);
            border-radius: 0 0 4px 4px;
            height: 88%;
            line-height: 88%;
            font-weight: 700;
            color: #000;
        }
        
        .tab button.active {
            border: 1px solid rgba(255,255,255,.4);
            border-top: 2px solid rgba(255,255,255,0);
        }
        
        .tabcontent {
            height: 100%;
            width: 100%;
            border: 1px solid rgba(192,192,192,.8);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: rgba(255,255,255,.4);
        }
        
        #messagesContainer {
            height: 100%;
            width: 100%;
            padding-top: 12px;
            position: relative;
            overflow-y: auto;
        }
        
        #messages {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .message {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,.1);
            transition: background-color 0.2s;
        }
        
        .message:hover {
            background-color: rgba(255,255,255,.05);
        }
        
        .message:last-child {
            border-bottom: none;
        }
        
        .smileyBar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            flex-wrap: wrap;
        }
        
        .emoticon {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .emoticon:hover {
            background-color: rgba(255,255,255,.2);
        }
        
        .textentry {
            background: rgba(255,255,255,.9);
            border: 1px solid rgba(192,192,192,.8);
            border-radius: 4px;
            color: #000;
            font-size: .9rem;
            line-height: 1.4;
        }
        
        .textentry:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 2px rgba(0,102,204,.2);
        }
        
        .textentry[placeholder]:empty:before {
            content: attr(placeholder);
            color: #999;
        }
        
        .butcontent {
            background: rgba(255,255,255,.4);
            border: 1px solid rgba(192,192,192,.8);
            border-radius: 4px;
            color: #000;
            cursor: pointer;
            font-size: .85rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s;
        }
        
        .butcontent:hover {
            background: rgba(255,255,255,.6);
            border-color: rgba(192,192,192,1);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,.2);
        }
        
        .listlinks {
            background: rgba(255,255,255,.4);
            border: none;
            color: #000;
            cursor: pointer;
            font-size: .8rem;
            font-weight: 600;
            padding: 4px 8px;
            transition: all 0.2s;
            border-radius: 4px 4px 0 0;
            border-bottom: 2px solid transparent;
        }
        
        .listlinks:hover {
            background: rgba(255,255,255,.6);
        }
        
        .listlinks.active {
            background: rgba(0,102,204,.8);
            color: white;
            border-bottom: 2px solid rgba(0,102,204,1);
        }
        
        .svgBack {
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            cursor: pointer;
            transition: opacity 0.2s;
            min-height: 30px;
        }
        
        .svgBack:hover {
            opacity: 0.8;
        }
        
        .smline {
            background-size: 60%;
        }
        
        .rightBtn {
            padding: 8px 12px;
        }
        
        .rightBtn .butcontent {
            padding: 8px 16px;
            font-size: .8rem;
        }
        
        .nav-icon {
            transition: transform 0.2s;
        }
        
        .nav-icon:hover {
            transform: scale(1.1);
            background: #444;
        }
        
        .pmIcon {
            left: 18px;
            z-index: 4;
            width: 50px;
            height: 60px;
            bottom: 16px;
            display: none;
            overflow: hidden;
            position: absolute;
            transform: scale(.9);
        }

        .frame {
            border: 0;
        }

        .sendMsg {
            background: rgba(255,255,255,.4);
            color: #000;
        }

        .mainButtons {
            background: rgba(255,255,255,.4);
            color: #000;
        }
        
        .butcontainer {
            margin: 4px 0;
        }

        #background {
            min-height: 100%;
        }

        /* Table rows should maintain their height proportions */
        
        /* Fix scrollbar */
        #messagesContainer::-webkit-scrollbar {
            width: 6px;
        }
        
        #messagesContainer::-webkit-scrollbar-track {
            background: rgba(255,255,255,.1);
            border-radius: 3px;
        }
        
        #messagesContainer::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,.3);
            border-radius: 3px;
        }
        
        #messagesContainer::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,.5);
        }

        /* Layout fixed - removed debug borders */
        
        /* Fix potential table layout issues */
        .table {
            display: table;
            width: 100%;
            height: 100%;
            table-layout: fixed;
        }
        
        .row {
            display: table-row;
        }
        
        .cell {
            display: table-cell;
            vertical-align: top;
        }
        
        /* Ensure content is visible */
        #background {
            min-height: 100vh;
            position: relative;
        }
        
        /* Force visibility of critical elements */
        #messagesTabContainer,
        #visitorsTabContainer,
        #listtabs,
        .smileyBar,
        #textEntryEditable,
        #returnBut {
            display: block;
            visibility: visible;
            opacity: 1;
        }
        
        /* Layout fixed - content visibility issues resolved */
        #messagesContainer {
            height: 100%;
            width: 100%;
            padding-top: 12px;
            position: relative;
            overflow-y: auto;
        }
        
        #messages {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .message {
            padding: 8px 12px;
            border-bottom: 1px solid rgba(255,255,255,.1);
            transition: background-color 0.2s;
        }
        
        /* Smilies horizontal layout */
        .smileyBar {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px;
            flex-wrap: wrap;
            flex-direction: row;
        }
        
        #smileyBar {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 6px;
            flex-wrap: wrap;
        }
        
        /* Visitors container */
        #visitorsContainer {
            height: 100%;
            width: 100%;
        }
        
        #idvisitors {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        /* Tab content */
        .tabcontent {
            height: 100%;
            width: 100%;
            border: 1px solid rgba(192,192,192,.8);
            border-bottom: none;
            border-radius: 4px 4px 0 0;
            background-color: rgba(255,255,255,.4);
        }
        
        /* Overlays */
        #messagesOverlay,
        #visitorsOverlay {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }
        
        #messagesSuperContainer,
        #visitorsContainer {
            overflow: visible;
            height: 100%;
        }

        /* Clean, professional styling - no debug borders */
        

    </style>
    
    <!-- Socket.IO for real-time communication -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- Main chat functionality -->
    <script>
        // Global variables
        let socket;
        let currentUser = null;
        let currentChat = {
            _id: 'default-chat',
            name: 'Main Chat',
            description: 'Welcome to the main chat room!'
        };
        let users = new Map();
        let messages = [];

        

        
        function loadUsersList() {
            const authToken = localStorage.getItem('authToken');
            
            if (!authToken) {
                console.log('üîê [USERS] No auth token, showing guest users');
                // Show guest users instead of login prompt
                const usersContainer = document.getElementById('idvisitors');
                if (usersContainer) {
                    usersContainer.innerHTML = `
                        <li style="background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px;">
                            <div style="display:flex;align-items:center;gap:10px;">
                                <div style="width:32px;height:32px;background:#95a5a6;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">G</div>
                                <div style="flex:1;">
                                    <div style="display:flex;align-items:center;gap:5px;">
                                        <strong>Guest</strong>
                                        <span style="background:#95a5a6;color:white;padding:2px 6px;border-radius:3px;font-size:10px;text-transform:uppercase;">Guest</span>
                                        <span style="width:8px;height:8px;background:#27ae60;border-radius:50%;display:inline-block;"></span>
                                    </div>
                                    <small style="color:#bdc3c7;">Click Sign In to join the chat</small>
                                </div>
                            </div>
                        </li>
                    `;
                }
                return;
            }
            
            console.log('üîê [USERS] Loading users with auth token...');
            
            // Load REAL users from the database
            fetch('/api/users/online', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => {
                if (response.status === 403) {
                    console.log('üîê [USERS] Token expired, clearing auth');
                    clearStoredAuth();
                    location.reload();
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    console.log('üîê [USERS] Users loaded successfully:', data.users.length);
                    displayUsers(data.users);
                } else if (data) {
                    console.error('üîê [USERS] Failed to load users:', data.message);
                    const usersContainer = document.getElementById('idvisitors');
                    if (usersContainer) {
                        usersContainer.innerHTML = '<li style="background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px; text-align: center;">No users online</li>';
                    }
                }
            })
            .catch(error => {
                console.error('üîê [USERS] Error loading users:', error);
                const usersContainer = document.getElementById('idvisitors');
                if (usersContainer) {
                    usersContainer.innerHTML = '<li style="background: #e74c3c; color: white; padding: 10px; margin: 5px; border-radius: 5px; text-align: center;">Error loading users</li>';
                }
            });
        }
        
        function loadFriendsList() {
            // Load friends from the database
            fetch('/api/users/friends', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.friends && data.friends.length > 0) {
                    displayFriends(data.friends);
                } else {
                    // Show no friends message
                    const usersContainer = document.getElementById('idvisitors');
                    if (usersContainer) {
                        usersContainer.innerHTML = `
                            <li style="background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px; text-align: center;">
                                <div style="font-size: 16px; margin-bottom: 8px;">üë•</div>
                                <div style="font-size: 14px; margin-bottom: 5px;">No friends yet</div>
                                <div style="font-size: 11px; color: #888;">Add friends to see them here</div>
                            </li>
                        `;
                    }
                }
            })
            .catch(error => {
                console.error('Error loading friends:', error);
                // Show error state
                const usersContainer = document.getElementById('idvisitors');
                if (usersContainer) {
                    usersContainer.innerHTML = '<li style="background: #e74c3c; color: white; padding: 10px; margin: 5px; border-radius: 5px; text-align: center;">Error loading friends</li>';
                }
            });
        }
        
        // ============================================================================
        // IXAT RANKING SYSTEM
        // ============================================================================
        
        function getIXatRankName(f) {
            switch(f) {
                case 0: return 'Guest';
                case 1: return 'Main Owner';
                case 2: return 'Moderator';
                case 3: return 'Member';
                case 4: return 'VIP';
                case 5: return 'Premium';
                case 6: return 'Gold';
                case 7: return 'Diamond';
                case 8: return 'Banned';
                default: return 'User';
            }
        }
        
        function getIXatRankColor(f) {
            switch(f) {
                case 0: return '#95a5a6'; // Guest - Grey
                case 1: return '#e74c3c'; // Main Owner - Red
                case 2: return '#f39c12'; // Moderator - Orange
                case 3: return '#3498db'; // Member - Blue
                case 4: return '#9b59b6'; // VIP - Purple
                case 5: return '#1abc9c'; // Premium - Teal
                case 6: return '#f1c40f'; // Gold - Yellow
                case 7: return '#e67e22'; // Diamond - Orange
                case 8: return '#c0392b'; // Banned - Dark Red
                default: return '#95a5a6'; // Default - Grey
            }
        }
        
        function getIXatRank(f) {
            return f || 0;
        }
        
        function displayUsers(userList) {
            const usersContainer = document.getElementById('idvisitors');
            if (!usersContainer) return;
            
            usersContainer.innerHTML = '';
            
            userList.forEach(user => {
                const userElement = document.createElement('li');
                userElement.style.cssText = 'background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px; cursor: pointer; transition: all 0.2s;';
                
                // Get rank info from the f flag
                const rank = getIXatRankName(user.f || 0);
                const rankColor = getIXatRankColor(user.f || 0);
                
                userElement.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;background:${getUserAvatarColor(user.username)};border-radius:50%;display:flex:align-items:center;justify-content:center;font-weight:bold;font-size:14px;">
                            ${user.username.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:5px;">
                                <strong>${user.username}</strong>
                                <span style="background:${rankColor};color:white;padding:2px 6px;border-radius:3px;font-size:10px;text-transform:uppercase;">${rank}</span>
                                <span style="width:8px;height:8px;background:${user.isOnline ? '#27ae60' : '#e74c3c'};display:inline-block;"></span>
                            </div>
                            <small style="color:#bdc3c7;">Xats: ${user.xats || 0} | Days: ${user.days || 0}</small>
                        </div>
                    </div>
                `;
                userElement.onclick = () => showUserProfile(user);
                userElement.onmouseenter = () => userElement.style.transform = 'scale(1.02)';
                userElement.onmouseleave = () => userElement.style.transform = 'scale(1)';
                usersContainer.appendChild(userElement);
            });
        }
        
        function displayFriends(friendsList) {
            const usersContainer = document.getElementById('idvisitors');
            if (!usersContainer) return;
            
            usersContainer.innerHTML = '';
            
            friendsList.forEach(friend => {
                const friendElement = document.createElement('li');
                friendElement.style.cssText = 'background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px; cursor: pointer; transition: all 0.2s;';
                friendElement.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;background:${getUserAvatarColor(friend.username)};border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">
                            ${friend.username.charAt(0).toUpperCase()}
                        </div>
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:5px;">
                                <strong>${friend.username}</strong>
                                <span style="background:#27ae60;color:white;padding:2px 6px;border-radius:3px;font-size:10px;text-transform:uppercase;">Friend</span>
                                <span style="width:8px;height:8px;background:${friend.isOnline ? '#27ae60' : '#e74c3c'};border-radius:50%;display:inline-block;"></span>
                            </div>
                            <small style="color:#bdc3c7;">Status: ${friend.status || 'Online'}</small>
                        </div>
                    </div>
                `;
                friendElement.onclick = () => showUserProfile(friend);
                friendElement.onmouseenter = () => friendElement.style.transform = 'scale(1.02)';
                friendElement.onmouseleave = () => friendElement.style.transform = 'scale(1)';
                usersContainer.appendChild(friendElement);
            });
        }
        
        function getUserAvatarColor(username) {
            const colors = ['#e74c3c', '#3498db', '#9b59b6', '#f39c12', '#1abc9c', '#e67e22', '#34495e'];
            const index = username.charCodeAt(0) % colors.length;
            return colors[index];
        }
        
        function getRankColor(rank) {
            const rankColors = {
                'mainowner': '#e74c3c',
                'owner': '#f39c12',
                'moderator': '#9b59b6',
                'member': '#3498db',
                'user': '#95a5a6'
            };
            return rankColors[rank] || rankColors['user'];
        }
        
        // ============================================================================
        // REAL iXat RANKING SYSTEM (based on your actual files)
        // ============================================================================
        
        function getIXatRank(f) {
            // Based on your actual iXat mobile.php relrank function
            if (f & 16) return 0; // Banned
            
            const ranks = [1, 5, 3, 2, 4, 1];
            return ranks[f & 7];
        }
        
        function getIXatRankColor(f) {
            // Based on your actual iXat color system
            const colors = ['#00ff00', 'orange', '#ffffff', '#6666ff', 'orange', '#00ff00'];
            return colors[f & 7] || '#00ff00';
        }
        
        function getIXatRankName(f) {
            const rankNames = ['Banned', 'Guest', 'Member', 'Moderator', 'Owner', 'Main Owner'];
            const rank = getIXatRank(f);
            return rankNames[rank] || 'Unknown';
        }
        
        function canModerateUser(myRank, targetRank) {
            // Based on iXat permission system
            if (myRank >= 5) return true; // Main Owner can do everything
            if (myRank >= 4 && targetRank < 5) return true; // Owner can moderate non-owners
            if (myRank >= 3 && targetRank < 3) return true; // Moderator can moderate guests/members
            return false;
        }
        
        function getModerationActions(myRank, targetRank) {
            const actions = [];
            
            if (myRank > 2) actions.push({ cmd: '/r', name: 'Make Guest', color: '#00ff00' });
            if (myRank > 2) actions.push({ cmd: '/e', name: 'Make Member', color: '#ffffff' });
            if (myRank > 3) actions.push({ cmd: '/m', name: 'Make Moderator', color: '#6666ff' });
            if (myRank > 4) actions.push({ cmd: '/M', name: 'Make Owner', color: 'orange' });
            
            return actions;
        }
        
        function showUserProfile(user) {
            // Show user profile modal with REAL iXat permissions
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            // Check if user clicked their own profile
            if (user.id === currentUser?.id) {
                showOwnProfile(user);
                return;
            }
            
            // Check REAL iXat moderation permissions
            const myRank = getIXatRank(currentUser?.f || 0);
            const targetRank = getIXatRank(user.f || 0);
            const canModerate = canModerateUser(myRank, targetRank);
            const canBan = myRank >= 4; // Owner+ can ban
            
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ecf0f1;">${user.username}'s Profile</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:#e74c3c;font-size:24px;cursor:pointer;">√ó</button>
                    </div>
                    
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                        <div>
                            <p><strong>Rank:</strong> <span style="color:${getRankColor(user.rank)}">${user.rank || 'User'}</span></p>
                            <p><strong>Xats:</strong> ${user.xats || 0}</p>
                            <p><strong>Days:</strong> ${user.days || 0}</p>
                            <p><strong>Status:</strong> <span style="color:${user.isOnline ? '#27ae60' : '#e74c3c'}">${user.isOnline ? 'Online' : 'Offline'}</span></p>
                        </div>
                        <div>
                            <p><strong>Warnings:</strong> <span id="warningCount-${user._id}">Loading...</span></p>
                            <p><strong>Mute Status:</strong> <span id="muteStatus-${user._id}">Loading...</span></p>
                            <p><strong>Ban Status:</strong> <span id="banStatus-${user._id}">Loading...</span></p>
                        </div>
                    </div>
                    
                    ${canModerate ? `
                        <div style="border-top:1px solid #34495e;padding-top:20px;margin-bottom:20px;">
                            <h3 style="color:#ecf0f1;margin-bottom:15px;">Moderation Actions</h3>
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                                <button onclick="issueWarning('${user._id}')" style="padding:8px 12px;background:#f39c12;color:white;border:none;border-radius:5px;cursor:pointer;font-size:12px;">‚ö†Ô∏è Warning</button>
                                <button onclick="muteUser('${user._id}')" style="padding:8px 12px;background:#e67e22;color:white;border:none;border-radius:5px;cursor:pointer;font-size:12px;">üîá Mute</button>
                                <button onclick="kickUser('${user.username}')" style="padding:8px 12px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;font-size:12px;">üë¢ Kick</button>
                                ${canBan ? `<button onclick="banUser('${user._id}')" style="padding:8px 12px;background:#c0392b;color:white;border:none;border-radius:5px;cursor:pointer;font-size:12px;">üö´ Ban</button>` : ''}
                            </div>
                        </div>
                        
                        <div style="border-top:1px solid #34495e;padding-top:20px;">
                            <h3 style="color:#ecf0f1;margin-bottom:15px;">Moderation History</h3>
                            <div id="modHistory-${user._id}" style="max-height:200px;overflow-y:auto;background:#34495e;padding:10px;border-radius:5px;">
                                <p style="text-align:center;color:#95a5a6;">Loading history...</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#7f8c8d;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load moderation data
            if (canModerate) {
                loadUserModerationData(user._id);
            }
        }
        
        function kickUser(username) {
            if (confirm(`Are you sure you want to kick ${username}?`)) {
                fetch('/api/users/kick', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ username })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`${username} has been kicked.`);
                        loadUsersList(); // Refresh users list
                    } else {
                        alert('Failed to kick user: ' + data.message);
                    }
                });
            }
        }
        
        function initializeSocket() {
            if (!currentUser) return;
            
            socket = io();
            
            socket.on('connect', () => {
                console.log('Connected to server');
                socket.emit('authenticate', {
                    userId: currentUser._id,
                    username: currentUser.username,
                    rank: currentUser.rank
                });
            });
            
            socket.on('authenticated', (data) => {
                console.log('Authenticated with server');
            });
            
            socket.on('chat_message', (message) => {
                addMessage(message);
            });
            
            socket.on('user_joined', (user) => {
                addSystemMessage(`${user.username} joined the chat`);
                loadUsersList(); // Refresh users list
            });
            
            socket.on('user_left', (user) => {
                addSystemMessage(`${user.username} left the chat`);
                loadUsersList(); // Refresh users list
            });
        }
        
        function setupEventListeners() {
            // Message input
            const messageInput = document.getElementById('textEntryEditable');
            if (messageInput) {
                messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Send button
            const sendButton = document.getElementById('returnBut');
            if (sendButton) {
                sendButton.addEventListener('click', sendMessage);
            }
        }
        
        function sendMessage() {
            if (!currentUser || !currentChat) return;
            
            const messageInput = document.getElementById('textEntryEditable');
            const message = messageInput.textContent.trim();
            
            if (!message) return;
            
            // Clear input
            messageInput.textContent = '';
            
            // Send via socket
            if (socket) {
                socket.emit('send_message', {
                    message,
                    userId: currentUser._id,
                    username: currentUser.username,
                    rank: currentUser.rank,
                    chatId: currentChat._id
                });
            }
        }
        
        function addMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('li');
            messageElement.className = 'message';
            messageElement.style.cssText = 'background: #2c3e50; color: white; padding: 10px; margin: 5px; border-radius: 5px;';
            messageElement.innerHTML = `
                <strong>${message.author.username}</strong> 
                <small style="color:#bdc3c7;">${new Date(message.timestamp).toLocaleTimeString()}</small>
                <br>${message.content}
            `;
            messagesContainer.appendChild(messageElement);
            
            // Auto-scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function addSystemMessage(message) {
            const messagesContainer = document.getElementById('messages');
            const messageElement = document.createElement('li');
            messageElement.className = 'message system';
            messageElement.style.cssText = 'background: #34495e; color: #f39c12; padding: 8px; margin: 3px; border-radius: 5px; font-style: italic; text-align: center;';
            messageElement.textContent = message;
            messagesContainer.appendChild(messageElement);
            
            // Auto-scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // POWERS SYSTEM
        let userPowers = [];
        
        function loadUserPowers() {
            const authToken = localStorage.getItem('authToken');
            if (!authToken) {
                console.log('üé≠ [POWERS] No auth token, skipping powers load');
                return;
            }
            
            fetch('/api/powers/user', {
                headers: { 'Authorization': `Bearer ${authToken}` }
            })
            .then(response => {
                if (response.status === 403) {
                    console.log('üé≠ [POWERS] Token expired, clearing auth');
                    clearStoredAuth();
                    location.reload();
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    userPowers = data.powers;
                    updatePowersDisplay();
                } else if (data) {
                    console.error('Failed to load powers:', data.message);
                }
            })
            .catch(error => {
                console.error('Error loading powers:', error);
                // Don't show error for powers, just log it
            });
        }
        
        function updatePowersDisplay() {
            // Update powers display in sidebar
            const powersContainer = document.getElementById('smileyBar');
            if (powersContainer && userPowers.length > 0) {
                const powersHTML = userPowers.map(power => 
                    `<button class="emoticon" onclick="activatePower('${power._id}', '${power.name}')" title="${power.name} - ${power.description} - Cost: ${power.cost || 0} xats" style="position:relative;">
                        ${power.icon || '‚ö°'}
                        ${power.cost > 0 ? `<span style="position:absolute;top:-5px;right:-5px;background:#e74c3c;color:white;font-size:10px;padding:2px 4px;border-radius:50%;min-width:16px;text-align:center;">${power.cost}</span>` : ''}
                    </button>`
                ).join('');
                powersContainer.innerHTML = powersHTML;
            }
        }
        
        function activatePower(powerId, powerName) {
            if (!currentUser) return;
            
            // For now, just show a message
            addSystemMessage(`üé≠ ${currentUser.username} activated power: ${powerName}!`);
            
            // In the future, this would:
            // 1. Check if user has the power
            // 2. Apply power effects
            // 3. Send to server
            // 4. Broadcast to other users
        }
        
        // üõí XAT POWERS STORE SYSTEM
        function showPowersStore() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#1a1a1a;padding:0;border-radius:15px;max-width:95%;width:1400px;max-height:90%;overflow:hidden;border:3px solid #333;box-shadow:0 0 50px rgba(0,0,0,0.8);">
                    <!-- HEADER -->
                    <div style="background:linear-gradient(135deg,#2c3e50,#34495e);padding:25px;border-bottom:3px solid #333;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h2 style="margin:0;color:white;font-size:28px;">üõí XAT POWERS STORE</h2>
                                <div style="color:#bdc3c7;margin-top:5px;font-size:14px;">Buy powers, aces, and more with your xats!</div>
                            </div>
                            <div style="text-align:right;">
                                <div style="background:#f39c12;color:white;padding:8px 15px;border-radius:20px;font-size:16px;font-weight:bold;margin-bottom:10px;">
                                    üí∞ Your Xats: <span id="storeUserXats">${currentUser?.xats || 0}</span>
                                </div>
                                <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" style="background:#e74c3c;color:white;border:none;border-radius:50%;width:45px;height:45px;font-size:24px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.3);">√ó</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- NAVIGATION TABS -->
                    <div style="background:#2c3e50;padding:20px;border-bottom:3px solid #333;">
                        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:15px;">
                            <button onclick="filterPowers('latest')" class="powerTab" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üÜï Latest</button>
                            <button onclick="filterPowers('all')" class="powerTab active" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üåü All Powers</button>
                            <button onclick="filterPowers('standard')" class="powerTab" style="padding:10px 20px;background:#95a5a6;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">‚ö° Standard</button>
                            <button onclick="filterPowers('rare')" class="powerTab" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üíé Rare</button>
                            <button onclick="filterPowers('epic')" class="powerTab" style="padding:10px 20px;background:#9b59b6;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üî• Epic</button>
                            <button onclick="filterPowers('group')" class="powerTab" style="padding:10px 20px;background:#e67e22;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üë• Group</button>
                            <button onclick="filterPowers('games')" class="powerTab" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üéÆ Games</button>
                            <button onclick="filterPowers('moderation')" class="powerTab" style="padding:10px 20px;background:#c0392b;color:white;border:none;border-radius:25px;cursor:pointer;font-size:13px;font-weight:bold;transition:all 0.3s ease;">üõ°Ô∏è Moderation</button>
                        </div>
                        
                        <!-- SEARCH & SORT -->
                        <div style="display:flex;gap:15px;align-items:center;flex-wrap:wrap;">
                            <div style="flex:1;min-width:300px;">
                                <input type="text" id="powerSearch" placeholder="üîç Search powers by name or description..." style="width:100%;padding:12px;background:#34495e;color:white;border:2px solid #555;border-radius:8px;font-size:14px;">
                            </div>
                            <select id="powerSort" style="padding:10px;background:#34495e;color:white;border:2px solid #555;border-radius:8px;font-size:14px;min-width:150px;">
                                <option value="name_az">üìù Name A-Z</option>
                                <option value="name_za">üìù Name Z-A</option>
                                <option value="price_low">üí∞ Price Low-High</option>
                                <option value="price_high">üí∞ Price High-Low</option>
                                <option value="rarity">‚≠ê Rarity</option>
                                <option value="newest">üÜï Newest First</option>
                            </select>
                            <div style="display:flex;gap:10px;align-items:center;">
                                <input type="number" id="minCost" placeholder="Min xats" style="width:80px;padding:8px;background:#34495e;color:white;border:1px solid #555;border-radius:5px;text-align:center;">
                                <span style="color:#bdc3c7;">to</span>
                                <input type="number" id="maxCost" placeholder="Max xats" style="width:80px;padding:8px;background:#34495e;color:white;border:1px solid #555;border-radius:5px;text-align:center;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- POWERS GRID -->
                    <div id="powersGrid" style="padding:25px;max-height:600px;overflow-y:auto;background:#1a1a1a;">
                        <div style="text-align:center;color:#95a5a6;padding:60px;">
                            <div style="font-size:48px;margin-bottom:20px;">üîç</div>
                            <div style="font-size:18px;">Loading powers from xat.com...</div>
                            <div style="font-size:14px;color:#7f8c8d;margin-top:10px;">Fetching latest power data</div>
                        </div>
                    </div>
                    
                    <!-- SHOPPING CART -->
                    <div id="powerCart" style="background:#2c3e50;padding:25px;border-top:3px solid #333;display:none;">
                        <h4 style="margin:0 0 20px 0;color:white;font-size:20px;">üõí Shopping Cart</h4>
                        <div id="cartItems" style="margin-bottom:20px;"></div>
                        <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#34495e;border-radius:8px;">
                            <div style="color:#bdc3c7;font-size:16px;">
                                Total: <span id="cartTotal" style="color:#f39c12;font-weight:bold;font-size:18px;">0</span> xats
                            </div>
                            <button onclick="purchasePowers()" style="padding:15px 30px;background:#27ae60;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:16px;box-shadow:0 2px 10px rgba(0,0,0,0.3);">üí≥ Purchase All Powers</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Load powers from our backend
            loadStorePowers();
            
            // Add search functionality
            const searchInput = document.getElementById('powerSearch');
            searchInput.addEventListener('input', filterPowersBySearch);
            
            // Add sort functionality
            const sortSelect = document.getElementById('powerSort');
            sortSelect.addEventListener('change', sortPowers);
            
            // Add cost filter functionality
            const minCostInput = document.getElementById('minCost');
            const maxCostInput = document.getElementById('maxCost');
            minCostInput.addEventListener('input', filterPowersByCost);
            maxCostInput.addEventListener('input', filterPowersByCost);
        }
        
        function showPowersMenu() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:700px;width:90%;max-height:80%;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2>Your Powers</h2>
                        <button onclick="showPowersStore()" style="padding:12px 20px;background:#f39c12;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;">üõí Powers Store</button>
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px;margin-top:20px;">
                        ${userPowers.map(power => `
                            <div style="background:#34495e;padding:15px;border-radius:8px;text-align:center;cursor:pointer;" onclick="activatePower('${power._id}', '${power.name}')">
                                <div style="font-size:24px;margin-bottom:10px;">${power.icon || '‚ö°'}</div>
                                <div style="font-weight:bold;margin-bottom:5px;">${power.name}</div>
                                <div style="font-size:12px;color:#bdc3c7;">${power.description}</div>
                                <div style="font-size:11px;color:#95a5a6;margin-top:5px;">Cost: ${power.cost || 0} xats</div>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // üõí STORE FUNCTIONALITY
        function loadStorePowers() {
            console.log('üîç Loading store powers...');
            fetch('/api/powers', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => {
                console.log('üì° Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('üì¶ Powers data received:', data);
                
                // Handle both response formats
                if (data.success && data.powers) {
                    displayStorePowers(data.powers);
                } else if (data.powers) {
                    displayStorePowers(data.powers);
                } else if (data.message && data.count !== undefined) {
                    // Backend format: { message, count, powers }
                    displayStorePowers(data.powers || []);
                } else {
                    console.error('‚ùå Failed to load powers:', data);
                    document.getElementById('powersGrid').innerHTML = `
                        <div style="text-align:center;color:#e74c3c;padding:40px;">
                            <div style="font-size:24px;">‚ùå</div>
                            <div>Failed to load powers</div>
                            <div style="font-size:14px;color:#95a5a6;margin-top:10px;">${data.message || 'Unknown error'}</div>
                            <div style="font-size:12px;color:#7f8c8d;margin-top:10px;">Response: ${JSON.stringify(data)}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                console.error('‚ùå Error loading powers:', error);
                document.getElementById('powersGrid').innerHTML = `
                    <div style="text-align:center;color:#e74c3c;padding:40px;">
                        <div style="font-size:24px;">‚ùå</div>
                        <div>Error loading powers</div>
                        <div style="font-size:14px;color:#95a5a6;margin-top:10px;">${error.message}</div>
                        <div style="font-size:12px;color:#7f8c8d;margin-top:10px;">Check console for details</div>
                    </div>
                `;
            });
        }
        
        function displayStorePowers(powers) {
            const grid = document.getElementById('powersGrid');
            if (!grid) return;
            
            if (powers.length === 0) {
                grid.innerHTML = `
                    <div style="text-align:center;color:#95a5a6;padding:60px;">
                        <div style="font-size:48px;margin-bottom:20px;">üîç</div>
                        <div style="font-size:18px;">No powers found</div>
                        <div style="font-size:14px;color:#7f8c8d;margin-top:10px;">Try adjusting your filters</div>
                    </div>
                `;
                return;
            }
            
            grid.innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(350px,1fr));gap:20px;">
                    ${powers.map(power => `
                        <div class="powerCard" data-category="${power.section || 'standard'}" data-rarity="${power.type || 'standard'}" data-cost="${power.cost || 0}" data-name="${power.name.toLowerCase()}" data-description="${power.description.toLowerCase()}" style="background:#2c3e50;padding:20px;border-radius:12px;border:3px solid ${getPowerRarityColor(power.type || 'standard')};transition:all 0.3s ease;cursor:pointer;" onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
                            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:15px;">
                                <div style="flex:1;">
                                    <h3 style="margin:0;color:white;font-size:20px;margin-bottom:8px;">${power.name}</h3>
                                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px;">
                                        <span style="background:${getPowerRarityColor(power.type || 'standard')};color:white;padding:4px 10px;border-radius:15px;font-size:11px;text-transform:uppercase;font-weight:bold;">${power.type || 'standard'}</span>
                                        ${power.section ? `<span style="background:#34495e;color:white;padding:4px 10px;border-radius:15px;font-size:11px;">${power.section}</span>` : ''}
                                        ${power.limited ? `<span style="background:#e74c3c;color:white;padding:4px 10px;border-radius:15px;font-size:11px;">LIMITED</span>` : ''}
                                    </div>
                                </div>
                                <div style="text-align:right;margin-left:15px;">
                                    <div style="font-size:32px;color:${getPowerRarityColor(power.type || 'standard')};margin-bottom:8px;">${power.smilies ? power.smilies.split(',')[0] : '‚ö°'}</div>
                                    <div style="background:#f39c12;color:white;padding:8px 15px;border-radius:20px;font-weight:bold;font-size:16px;box-shadow:0 2px 10px rgba(0,0,0,0.3);">${power.cost || 0} xats</div>
                                </div>
                            </div>
                            
                            <div style="color:#bdc3c7;margin-bottom:20px;line-height:1.5;font-size:14px;">
                                ${power.description || 'No description available'}
                            </div>
                            
                            <div style="display:flex;gap:10px;align-items:center;">
                                <input type="number" id="qty_${power._id}" value="1" min="1" max="99" style="width:70px;padding:8px;background:#34495e;color:white;border:2px solid #555;border-radius:6px;text-align:center;font-size:14px;">
                                <button onclick="addToCart('${power._id}', '${power.name}', ${power.cost || 0})" style="flex:1;padding:12px;background:#27ae60;color:white;border:none;border-radius:8px;cursor:pointer;font-weight:bold;font-size:14px;transition:all 0.3s ease;" onmouseover="this.style.background='#2ecc71'" onmouseout="this.style.background='#27ae60'">üõí Add to Cart</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function filterPowers(category) {
            // Update active tab
            document.querySelectorAll('.powerTab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Filter powers
            const cards = document.querySelectorAll('.powerCard');
            cards.forEach(card => {
                if (category === 'all' || card.dataset.category === category || card.dataset.rarity === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterPowersBySearch() {
            const searchTerm = document.getElementById('powerSearch').value.toLowerCase();
            const cards = document.querySelectorAll('.powerCard');
            
            cards.forEach(card => {
                const powerName = card.dataset.name;
                const powerDesc = card.dataset.description;
                
                if (powerName.includes(searchTerm) || powerDesc.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function filterPowersByCost() {
            const minCost = parseInt(document.getElementById('minCost').value) || 0;
            const maxCost = parseInt(document.getElementById('maxCost').value) || 999999;
            const cards = document.querySelectorAll('.powerCard');
            
            cards.forEach(card => {
                const cost = parseInt(card.dataset.cost);
                if (cost >= minCost && cost <= maxCost) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }
        
        function sortPowers() {
            const sortType = document.getElementById('powerSort').value;
            const grid = document.getElementById('powersGrid');
            const cards = Array.from(grid.querySelectorAll('.powerCard'));
            
            cards.sort((a, b) => {
                const aName = a.querySelector('h3').textContent;
                const bName = b.querySelector('h3').textContent;
                const aCost = parseInt(a.dataset.cost);
                const bCost = parseInt(b.dataset.cost);
                const aRarity = a.dataset.rarity;
                const bRarity = b.dataset.rarity;
                
                switch(sortType) {
                    case 'name_az': return aName.localeCompare(bName);
                    case 'name_za': return bName.localeCompare(aName);
                    case 'price_low': return aCost - bCost;
                    case 'price_high': return bCost - aCost;
                    case 'rarity': return getRarityWeight(aRarity) - getRarityWeight(bRarity);
                    case 'newest': return 0; // Would need timestamp for this
                    default: return 0;
                }
            });
            
            // Reorder cards
            cards.forEach(card => grid.appendChild(card));
        }
        
        function getRarityWeight(rarity) {
            const weights = { 'standard': 1, 'rare': 2, 'epic': 3, 'legendary': 4, 'group': 5, 'moderation': 6 };
            return weights[rarity] || 0;
        }
        
        // Shopping cart functionality
        let cart = [];
        
        function addToCart(powerId, powerName, powerCost) {
            const quantity = parseInt(document.getElementById(`qty_${powerId}`).value);
            
            // Check if already in cart
            const existingItem = cart.find(item => item.id === powerId);
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                cart.push({ id: powerId, name: powerName, cost: powerCost, quantity: quantity });
            }
            
            updateCartDisplay();
            showCart();
            
            // Show success message
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Added!';
            button.style.background = '#27ae60';
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '#27ae60';
            }, 1500);
        }
        
        function updateCartDisplay() {
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            
            if (!cartItems || !cartTotal) return;
            
            cartItems.innerHTML = cart.map(item => `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:15px;background:#34495e;border-radius:8px;margin-bottom:10px;">
                    <div>
                        <div style="color:white;font-weight:bold;font-size:16px;">${item.name}</div>
                        <div style="color:#95a5a6;font-size:14px;">Quantity: ${item.quantity}</div>
                    </div>
                    <div style="display:flex;align-items:center;gap:15px;">
                        <div style="color:#f39c12;font-weight:bold;font-size:16px;">${item.cost * item.quantity} xats</div>
                        <button onclick="removeFromCart('${item.id}')" style="background:#e74c3c;color:white;border:none;border-radius:6px;padding:8px 12px;cursor:pointer;font-size:12px;">Remove</button>
                    </div>
                </div>
            `).join('');
            
            const total = cart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
            cartTotal.textContent = total;
        }
        
        function removeFromCart(powerId) {
            cart = cart.filter(item => item.id !== powerId);
            updateCartDisplay();
            
            if (cart.length === 0) {
                hideCart();
            }
        }
        
        function showCart() {
            const cartDiv = document.getElementById('powerCart');
            if (cartDiv) cartDiv.style.display = 'block';
        }
        
        function hideCart() {
            const cartDiv = document.getElementById('powerCart');
            if (cartDiv) cartDiv.style.display = 'none';
        }
        
        function purchasePowers() {
            if (cart.length === 0) return;
            
            const total = cart.reduce((sum, item) => sum + (item.cost * item.quantity), 0);
            const userXats = parseInt(document.getElementById('storeUserXats').textContent);
            
            if (total > userXats) {
                alert('‚ùå Not enough xats! You need ' + total + ' xats but only have ' + userXats + ' xats.');
                return;
            }
            
            // Purchase logic here
            fetch('/api/powers/purchase', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ items: cart })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('üéâ Powers purchased successfully!');
                    cart = [];
                    updateCartDisplay();
                    hideCart();
                    loadUserPowers(); // Refresh user powers
                    // Update user xats
                    if (currentUser) {
                        currentUser.xats -= total;
                        document.getElementById('storeUserXats').textContent = currentUser.xats;
                    }
                } else {
                    alert('‚ùå Purchase failed: ' + data.message);
                }
            });
        }
        
        function activatePower(powerId, powerName) {
            // Show target selection for powers that need targets
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:400px;width:90%;">
                    <h2>Activate ${powerName}</h2>
                    <p>Select a target user:</p>
                    <select id="powerTarget" style="width:100%;padding:10px;margin:10px 0;background:#34495e;color:white;border:none;border-radius:5px;">
                        <option value="">Select user...</option>
                        ${Array.from(users.values()).map(user => 
                            `<option value="${user.username}">${user.username} (${user.rank || 'User'})</option>`
                        ).join('')}
                    </select>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="executePower('${powerId}', '${powerName}')" style="padding:10px 20px;margin:5px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;">Activate</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;margin:5px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function executePower(powerId, powerName) {
            const target = document.getElementById('powerTarget').value;
            if (!target) {
                alert('Please select a target user');
                return;
            }
            
            // Close modal
            document.querySelector('[style*="position:fixed"]').remove();
            
            // Execute power
            fetch('/api/powers/activate', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ powerId, powerName, target })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show power effect animation
                    showPowerEffect(powerName, target);
                    
                    // Add system message
                    addSystemMessage(`‚ö° ${currentUser.username} used ${powerName} on ${target}!`);
                    
                    // Refresh powers if cost was deducted
                    loadUserPowers();
                    
                    // Update user's xats if cost was deducted
                    if (data.xatsDeducted) {
                        updateUserXats(data.newXats);
                    }
                } else {
                    alert('Failed to activate power: ' + data.message);
                }
            });
        }
        
        function showPowerEffect(powerName, target) {
            // Create power effect animation
            const effect = document.createElement('div');
            effect.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-size: 48px;
                z-index: 10001;
                pointer-events: none;
                animation: powerEffect 2s ease-out forwards;
            `;
            
            // Different effects for different power types
            const powerEffects = {
                'kick': 'üë¢',
                'ban': 'üö´',
                'mute': 'üîá',
                'freeze': '‚ùÑÔ∏è',
                'rainbow': 'üåà',
                'sparkle': '‚ú®',
                'fire': 'üî•',
                'ice': 'üßä',
                'lightning': '‚ö°',
                'shield': 'üõ°Ô∏è'
            };
            
            effect.textContent = powerEffects[powerName.toLowerCase()] || '‚ö°';
            effect.innerHTML += `<div style="font-size: 16px; text-align: center; margin-top: 10px; color: white;">${powerName} on ${target}</div>`;
            
            document.body.appendChild(effect);
            
            // Remove effect after animation
            setTimeout(() => effect.remove(), 2000);
        }
        
        function updateUserXats(newXats) {
            if (currentUser) {
                currentUser.xats = newXats;
                // Update display if xats are shown
                const xatsDisplay = document.querySelector('[data-xats-display]');
                if (xatsDisplay) {
                    xatsDisplay.textContent = newXats;
                }
            }
        }
        
        // GROUPS SYSTEM
        function showGroupsMenu() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>Groups Management</h2>
                    <div style="margin:20px 0;">
                        <button onclick="showCreateGroupForm()" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;">Create New Group</button>
                        <button onclick="loadUserGroups()" style="padding:10px 20px;margin-left:10px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">My Groups</button>
                    </div>
                    <div id="groupsContent">
                        <p>Select an option above to manage groups.</p>
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showCreateGroupForm() {
            const content = document.getElementById('groupsContent');
            content.innerHTML = `
                <h3>Create New Group</h3>
                <div style="margin:15px 0;">
                    <input type="text" id="groupName" placeholder="Group Name" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;">
                    <textarea id="groupDescription" placeholder="Group Description" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;height:80px;resize:none;"></textarea>
                    <select id="groupPrivacy" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                        <option value="invite">Invite Only</option>
                    </select>
                </div>
                <button onclick="createGroup()" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;">Create Group</button>
            `;
        }
        
        function createGroup() {
            const name = document.getElementById('groupName').value;
            const description = document.getElementById('groupDescription').value;
            const privacy = document.getElementById('groupPrivacy').value;
            
            if (!name) {
                alert('Please enter a group name');
                return;
            }
            
            fetch('/api/chats/create', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ 
                    name, 
                    description, 
                    privacy,
                    type: 'group'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Group created successfully!');
                    loadUserGroups();
                } else {
                    alert('Failed to create group: ' + data.message);
                }
            });
        }
        
        function loadUserGroups() {
            fetch('/api/chats/user', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUserGroups(data.chats);
                }
            });
        }
        
        function displayUserGroups(groups) {
            const content = document.getElementById('groupsContent');
            content.innerHTML = `
                <h3>My Groups</h3>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px;">
                    ${groups.map(group => `
                        <div style="background:#34495e;padding:15px;border-radius:8px;border-left:4px solid ${getPrivacyColor(group.privacy)};">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <h4 style="margin:0;">${group.name}</h4>
                                <span style="background:${getPrivacyColor(group.privacy)};color:white;padding:2px 8px;border-radius:12px;font-size:10px;text-transform:uppercase;">${group.privacy}</span>
                            </div>
                            <p style="margin:0 0 10px 0;color:#bdc3c7;">${group.description || 'No description'}</p>
                            <div style="font-size:12px;color:#95a5a6;margin-bottom:15px;">
                                <div style="margin-bottom:5px;">üë• Members: ${group.members?.length || 0}</div>
                                <div style="margin-bottom:5px;">üìÖ Created: ${new Date(group.createdAt).toLocaleDateString()}</div>
                                ${group.lastActivity ? `<div>üïí Last Activity: ${new Date(group.lastActivity).toLocaleDateString()}</div>` : ''}
                            </div>
                            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                                <button onclick="viewGroupMembers('${group._id}')" style="padding:8px 15px;background:#3498db;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Members</button>
                                <button onclick="joinGroup('${group._id}')" style="padding:8px 15px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Join</button>
                                ${group.owner === currentUser._id ? 
                                    `<button onclick="editGroup('${group._id}')" style="padding:8px 15px;background:#f39c12;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Edit</button>
                                     <button onclick="manageGroup('${group._id}')" style="padding:8px 15px;background:#e74c3c;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Manage</button>` : 
                                    ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getPrivacyColor(privacy) {
            const colors = {
                'public': '#27ae60',
                'private': '#e74c3c',
                'invite': '#f39c12'
            };
            return colors[privacy] || '#95a5a6';
        }
        
        function viewGroupMembers(groupId) {
            fetch(`/api/chats/${groupId}/members`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showMembersModal(data.members, data.groupName);
                }
            });
        }
        
        function showMembersModal(members, groupName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:500px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>${groupName} - Members</h2>
                    <div style="margin-top:20px;">
                        ${members.map(member => `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#34495e;margin:5px 0;border-radius:5px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:24px;height:24px;background:${getUserAvatarColor(member.username)};border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;">
                                        ${member.username.charAt(0).toUpperCase()}
                                    </div>
                                    <span>${member.username}</span>
                                    <span style="background:${getRankColor(member.role)};color:white;padding:2px 6px;border-radius:3px;font-size:10px;">${member.role || 'Member'}</span>
                                </div>
                                <span style="font-size:12px;color:#95a5a6;">${member.joinedAt ? new Date(member.joinedAt).toLocaleDateString() : 'Unknown'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // CHAT MANAGEMENT
        function showChatManagement() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>Chat Management</h2>
                    <div style="margin:20px 0;">
                        <button onclick="showCreateChatForm()" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;">Create New Chat</button>
                        <button onclick="loadUserChats()" style="padding:10px 20px;margin-left:10px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">My Chats</button>
                    </div>
                    <div id="chatManagementContent">
                        <p>Select an option above to manage chats.</p>
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function showCreateChatForm() {
            const content = document.getElementById('chatManagementContent');
            content.innerHTML = `
                <h3>Create New Chat</h3>
                <div style="margin:15px 0;">
                    <input type="text" id="chatName" placeholder="Chat Name" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;">
                    <textarea id="chatDescription" placeholder="Chat Description" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;height:80px;resize:none;"></textarea>
                    <select id="chatType" style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;margin:5px 0;">
                        <option value="public">Public Chat</option>
                        <option value="private">Private Chat</option>
                        <option value="group">Group Chat</option>
                    </select>
                </div>
                <button onclick="createChat()" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;">Create Chat</button>
            `;
        }
        
        function createChat() {
            const name = document.getElementById('chatName').value;
            const description = document.getElementById('chatDescription').value;
            const type = document.getElementById('chatType').value;
            
            if (!name) {
                alert('Please enter a chat name');
                return;
            }
            
            fetch('/api/chats/create', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ name, description, type })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Chat created successfully!');
                    loadUserChats();
                } else {
                    alert('Failed to create chat: ' + data.message);
                }
            });
        }
        
        function loadUserChats() {
            fetch('/api/chats/user', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayUserChats(data.chats);
                }
            });
            }
        
        function displayUserChats(chats) {
            const content = document.getElementById('chatManagementContent');
            content.innerHTML = `
                <h3>My Chats</h3>
                <div style="margin-bottom:20px;">
                    <button onclick="showPublicChats()" style="padding:10px 20px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;">Browse Public Chats</button>
                    <button onclick="showChatStats()" style="padding:10px 20px;background:#9b59b6;color:white;border:none;border-radius:5px;cursor:pointer;">Chat Statistics</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:15px;margin-top:20px;">
                    ${chats.map(chat => `
                        <div style="background:#34495e;padding:15px;border-radius:8px;border-left:4px solid ${getChatTypeColor(chat.type)};">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                                <h4 style="margin:0;">${chat.name}</h4>
                                <span style="background:${getChatTypeColor(chat.type)};color:white;padding:2px 8px;border-radius:12px;font-size:10px;text-transform:uppercase;">${chat.type}</span>
                            </div>
                            <p style="margin:0 0 10px 0;color:#bdc3c7;">${chat.description || 'No description'}</p>
                            <div style="font-size:12px;color:#95a5a6;margin-bottom:15px;">
                                <div style="margin-bottom:5px;">üë• Members: ${chat.members?.length || 0}</div>
                                <div style="margin-bottom:5px;">üìÖ Created: ${new Date(chat.createdAt).toLocaleDateString()}</div>
                                ${chat.lastActivity ? `<div>üïí Last Activity: ${new Date(chat.lastActivity).toLocaleDateString()}</div>` : ''}
                                ${chat.maxMembers ? `<div>üö´ Max Members: ${chat.maxMembers}</div>` : ''}
                            </div>
                            <div style="display:flex;gap:5px;flex-wrap:wrap;">
                                <button onclick="joinChat('${chat._id}')" style="padding:8px 15px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Join</button>
                                <button onclick="viewChatMembers('${chat._id}')" style="padding:8px 15px;background:#3498db;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Members</button>
                                ${chat.owner === currentUser._id ? 
                                    `<button onclick="editChat('${chat._id}')" style="padding:8px 15px;background:#f39c12;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Edit</button>
                                     <button onclick="manageChat('${chat._id}')" style="padding:8px 15px;background:#e74c3c;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Manage</button>
                                     <button onclick="deleteChat('${chat._id}')" style="padding:8px 15px;background:#c0392b;color:white;border:none;border-radius:3px;cursor:pointer;font-size:12px;">Delete</button>` : 
                                    ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function getChatTypeColor(type) {
            const colors = {
                'public': '#27ae60',
                'private': '#e74c3c',
                'group': '#3498db',
                'moderated': '#f39c12'
            };
            return colors[type] || '#95a5a6';
        }
        
        function showPublicChats() {
            fetch('/api/chats/public', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showPublicChatsModal(data.chats);
                }
            });
        }
        
        function showPublicChatsModal(chats) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:800px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>Public Chat Rooms</h2>
                    <div style="margin:20px 0;">
                        <input type="text" id="chatSearch" placeholder="Search chats..." style="width:100%;padding:10px;background:#34495e;color:white;border:none;border-radius:5px;">
                    </div>
                    <div id="publicChatsList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:15px;">
                        ${chats.map(chat => `
                            <div style="background:#34495e;padding:15px;border-radius:8px;border-left:4px solid #27ae60;">
                                <h4 style="margin:0 0 10px 0;">${chat.name}</h4>
                                <p style="margin:0 0 10px 0;color:#bdc3c7;font-size:12px;">${chat.description || 'No description'}</p>
                                <div style="font-size:11px;color:#95a5a6;margin-bottom:10px;">
                                    üë• ${chat.members?.length || 0} members
                                </div>
                                <button onclick="joinChat('${chat._id}')" style="width:100%;padding:8px;background:#27ae60;color:white;border:none;border-radius:3px;cursor:pointer;">Join Chat</button>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add search functionality
            const searchInput = document.getElementById('chatSearch');
            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const chatElements = document.querySelectorAll('#publicChatsList > div');
                chatElements.forEach(chat => {
                    const chatName = chat.querySelector('h4').textContent.toLowerCase();
                    const chatDesc = chat.querySelector('p').textContent.toLowerCase();
                    if (chatName.includes(searchTerm) || chatDesc.includes(searchTerm)) {
                        chat.style.display = 'block';
                    } else {
                        chat.style.display = 'none';
                    }
                });
            });
        }
        
        function showChatStats() {
            fetch('/api/chats/stats', {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showChatStatsModal(data.stats);
                }
            });
        }
        
        function showChatStatsModal(stats) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>Chat Statistics</h2>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;margin-top:20px;">
                        <div style="background:#34495e;padding:20px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#27ae60;">${stats.totalChats || 0}</div>
                            <div style="color:#bdc3c7;">Total Chats</div>
                        </div>
                        <div style="background:#34495e;padding:20px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#3498db;">${stats.totalMembers || 0}</div>
                            <div style="color:#bdc3c7;">Total Members</div>
                        </div>
                        <div style="background:#34495e;padding:20px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#f39c12;">${stats.activeChats || 0}</div>
                            <div style="color:#bdc3c7;">Active Chats</div>
                        </div>
                        <div style="background:#34495e;padding:20px;border-radius:8px;text-align:center;">
                            <div style="font-size:24px;font-weight:bold;color:#9b59b6;">${stats.totalMessages || 0}</div>
                            <div style="color:#bdc3c7;">Total Messages</div>
                        </div>
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function viewChatMembers(chatId) {
            fetch(`/api/chats/${chatId}/members`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showChatMembersModal(data.members, data.chatName);
                }
            });
        }
        
        function showChatMembersModal(members, chatName) {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80%;overflow-y:auto;">
                    <h2>${chatName} - Members</h2>
                    <div style="margin-top:20px;">
                        ${members.map(member => `
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:#34495e;margin:5px 0;border-radius:5px;">
                                <div style="display:flex;align-items:center;gap:10px;">
                                    <div style="width:24px;height:24px;background:${getUserAvatarColor(member.username)};border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:12px;">
                                        ${member.username.charAt(0).toUpperCase()}
                                    </div>
                                    <span>${member.username}</span>
                                    <span style="background:${getRankColor(member.role)};color:white;padding:2px 6px;border-radius:3px;font-size:10px;">${member.role || 'Member'}</span>
                                </div>
                                <span style="font-size:12px;color:#95a5a6;">${member.joinedAt ? new Date(member.joinedAt).toLocaleDateString() : 'Unknown'}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function manageChat(chatId) {
            // Show chat management options
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:500px;width:90%;">
                    <h2>Chat Management</h2>
                    <div style="margin:20px 0;">
                        <button onclick="inviteUsers('${chatId}')" style="width:100%;padding:15px;margin:5px 0;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">Invite Users</button>
                        <button onclick="setChatRules('${chatId}')" style="width:100%;padding:15px;margin:5px 0;background:#f39c12;color:white;border:none;border-radius:5px;cursor:pointer;">Set Chat Rules</button>
                        <button onclick="moderateChat('${chatId}')" style="width:100%;padding:15px;margin:5px 0;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Moderate Chat</button>
                        <button onclick="exportChatData('${chatId}')" style="width:100%;padding:15px;margin:5px 0;background:#9b59b6;color:white;border:none;border-radius:5px;cursor:pointer;">Export Chat Data</button>
                    </div>
                    <div style="margin-top:20px;text-align:center;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">Close</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        function deleteChat(chatId) {
            if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
                fetch(`/api/chats/${chatId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Chat deleted successfully!');
                        loadUserChats(); // Refresh the list
                    } else {
                        alert('Failed to delete chat: ' + data.message);
                    }
                });
            }
        }
        
        function joinChat(chatId) {
            fetch('/api/chats/join', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                },
                body: JSON.stringify({ chatId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentChat = data.chat;
                    addSystemMessage(`Joined chat: ${data.chat.name}`);
                    // Update interface to show current chat
                    updateChatInterface();
                } else {
                    alert('Failed to join chat: ' + data.message);
                }
            });
        }
        
        function updateChatInterface() {
            if (currentChat) {
                document.title = `iXat Chat - ${currentChat.name}`;
                // Load chat messages
                loadChatMessages();
            }
        }
        
        function loadChatMessages() {
            if (!currentChat) return;
            
            fetch(`/api/messages/chat/${currentChat._id}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messages = data.messages;
                    displayChatMessages();
                }
            });
        }
        
        function displayChatMessages() {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(message => {
                addMessage(message);
            });
        }
    </script>
</head>
<body>
    <!-- Page loaded successfully -->
    
    <div style="position:relative; width:100%; height:100%; overflow:hidden; max-width:100%; max-height:100%;">

        <div id="scroller">
            <span id="scrollText"></span>
        </div>
        
        <div id="chatContainer">
        <div id="background" class="table">
            <div class="row">
                <!-- Left Side - Chat Area (70%) - PROPER CHAT AREA -->
                <div class="cell" style="width:70%">
                    <div class="table" style="width:100%;height:100%">
                        <div class="row">
                            <div class="cell" style="width:100%;height:100%">
                                <div class="table" style="width:100%;height:100%">
                                    <div class="table" style="width:100%;height:100%">
                                        <!-- Chat Messages Area (72%) - MAIN CHAT CONTAINER BUBBLE -->
                                        <div class="row" style="width:100%;height:72%">
                                            <div class="cell" style="padding:.6rem .26667rem .13333rem .73333rem">
                                                <div id="messagesTabContainer" class="tabcontent" style="position:relative;z-index:2;height:100%;margin-bottom:0;">
                                                    <div id="messagesOverlay" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:2">
                                                        <div id="messagesSuperContainer" style="overflow:hidden;height:100%">
                                                            <div id="messagesContainer" class="frame">
                                                                <ul id="messages">
                                                                    <!-- Chat messages will appear here -->
                                                                    <li class="message" style="background: #2c3e50; color: white; padding: 10px; margin: 5px; border-radius: 5px;">Welcome to iXat Chat!</li>
                                                                </ul>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Smilies/Radio/8Ball Area (8%) - BELOW CHAT CONTAINER -->
                                        <div class="row" style="width:100%;height:8%">
                                            <div class="cell" style="padding:.3rem 0 .1rem .5rem">
                                                <div class="table" style="width:100%;height:100%;margin-top:4px;position:relative">
                                                    <div class="smileyBar">
                                                        <div id="smileyBar">
                                                            <button class="emoticon">üòä</button>
                                                            <button class="emoticon">üòÑ</button>
                                                            <button class="emoticon">üòâ</button>
                                                            <button class="emoticon">üòç</button>
                                                            <button class="emoticon">üòé</button>
                                                            <button class="emoticon">üò°</button>
                                                            <button class="emoticon">üò¢</button>
                                                            <button class="emoticon">üò≠</button>
                                                            <button class="emoticon">üò±</button>
                                                            <button class="emoticon">ü§î</button>
                                                            <button class="emoticon">üé±</button>
                                                            <button class="emoticon">üìª</button>
                                                            <button class="emoticon">üõí</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Message Input Area (20%) - BELOW SMILIES, FLEXIBLE LAYOUT -->
                                        <div class="row" style="width:100%;height:20%;margin-top:0;">
                                            <div class="cell" id="bottomSection" style="padding:.2rem .3rem .2rem .7rem">
                                                <!-- FLEXIBLE CONTAINER - BREAK OUT OF TABLE CONSTRAINTS -->
                                                <div style="display:flex;width:100%;height:100%;gap:10px;align-items:center;">
                                                    <!-- MESSAGE BOX - CAN BE WIDER -->
                                                    <div style="flex:1;height:100%;min-width:0;">
                                                        <span id="textEntryEditable" class="textentry frame" contenteditable="true" placeholder="Type your message..." style="overflow-y:auto;padding:8px;display:block;width:100%;height:100%;min-height:40px;box-sizing:border-box;border:2px solid #4CAF50;border-radius:5px;"></span>
                                                            <div id="pmWrapper" class="pmIcon"></div>
                                                            <div class="textentryBack frame" style="overflow-y:auto;padding:0 0 0 .3rem;transform:translateY(-100%)"></div>
                                                        </div>
                                                    <!-- ENTER KEY - CAN BE POSITIONED FREELY -->
                                                    <div style="flex-shrink:0;width:80px;height:100%;display:flex;align-items:center;justify-content:center;">
                                                        <div id="returnBut" class="butcontent sendMsg mainButtons" style="height:60%;width:100%;display:flex;align-items:center;justify-content:center;background:#808080;border-radius:5px;cursor:pointer;color:white;font-weight:bold;border:none;transition:all 0.2s ease;" onmouseover="this.style.background='#6c6c6c'" onmouseout="this.style.background='#808080'" onmousedown="this.style.background='#5a5a5a'" onmouseup="this.style.background='#6c6c6c'">
                                                            <span style="font-size:14px;">SEND</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Right Side - Sidebar (30%) - PROPER SIDEBAR -->
                <div class="cell" style="position:relative;z-index:2;width:30%">
                    <div class="table" style="width:100%;height:100%">
                        <div class="row">
                            <div class="cell" style="width:73%;height:100%">
                                <div class="table" style="width:100%;height:100%">
                                    <div class="table" style="width:100%;height:100%">
                                        <!-- Visitors/Friends Area (85%) - LONGER USER LIST SIZE -->
                                        <div class="row" style="width:100% !important;height:85% !important;margin-top:0 !important;">
                                            <div class="cell" id="usrList" style="padding:.2rem .76667rem .1rem .46667rem">
                                                <!-- User List Container (90% of this area) -->
                                                <div id="visitorsTabContainer" class="tabcontent" style="height:90%;margin-bottom:2px;">
                                                    <div id="visitorsOverlay" style="position:absolute;left:0;top:0;width:100%;height:100%;z-index:2">
                                                        <div id="visitorsContainer">
                                                            <ul id="idvisitors">
                                                                <!-- Visitors list will appear here -->
                                                                <li class="message" style="background: #34495e; color: white; padding: 10px; margin: 5px; border-radius: 5px;">No visitors online</li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!-- Tabs Container (15% of this area) - FLUSH TO BOTTOM OF USER LIST -->
                                                <div id="listtabs" class="tab" style="width:100% !important;height:15% !important;overflow:visible !important;margin-top:0 !important;">
                                                    <button id="defaultList" class="listlinks active" style="width:50%;height:25px;float:left;font-size: .85rem;background:#95a5a6 !important;color:white;border:none;cursor:pointer;transition:all 0.2s ease;font-weight:bold;" onmouseover="console.log('Visitors hover');this.style.setProperty('background', '#7f8c8d', 'important')" onmouseout="console.log('Visitors unhover');this.style.setProperty('background', '#95a5a6', 'important')" onmousedown="console.log('Visitors mousedown');this.style.setProperty('background', '#6c6c6c', 'important')" onmouseup="console.log('Visitors mouseup');this.style.setProperty('background', '#7f8c8d', 'important')">Visitors</button>
                                                    <button id="friendsList" class="listlinks" style="width:50%;height:25px;float:left;font-size: .85rem;background:#7f8c8d !important;color:white;border:none;cursor:pointer;transition:all 0.2s ease;font-weight:bold;" onmouseover="console.log('Friends hover');this.style.setProperty('background', '#6c6c6c', 'important')" onmouseout="console.log('Friends unhover');this.style.setProperty('background', '#7f8c8d', 'important')" onmousedown="console.log('Friends mousedown');this.style.setProperty('background', '#5a5a5a', 'important')" onmouseup="console.log('Friends mouseup');this.style.setProperty('background', '#6c6c6c', 'important')">Friends</button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Right Bar Icons (5%) -->
                                        <div class="row" style="width:100%;height:5%">
                                            <div class="cell" style="padding:0 .8rem 0 .1rem">
                                                <div class="table" style="width:100%;height:100%">
                                                    <div id="rightBarIcons" class="row">
                                                        <div id="groupBut" class="cell svgBack smline" style="width:23%;background-image:url(svg/groups.svg)"></div>
                                                        <div id="helpBut" class="cell svgBack smline" style="width:27%;background-image:url(svg/helpicon.svg)"></div>
                                                        <div id="xatBut" class="cell svgBack smline" style="width:49%;background-image:url(svg/xatsat.svg)"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Navigation Icons (5%) -->
                                        <div class="row" style="width:100%;height:5%">
                                            <div class="cell" style="padding:5px .8rem 0 .1rem">
                                                <div class="table" style="width:100%;height:100%">
                                                    <div class="row">
                                                        <div class="cell" style="width:33%;text-align:center;padding:5px;">
                                                            <a href="groups.html" style="text-decoration:none;color:#fff;">
                                                                <div class="nav-icon" style="background:#333;border-radius:50%;width:40px;height:40px;margin:0 auto;display:flex;align-items:center;justify-content:center;cursor:pointer;">
                                                                    <span style="font-size:16px;color:#fff;font-weight:bold;">G</span>
                                                                </div>
                                                                <div style="font-size:10px;margin-top:5px;">Groups</div>
                                                            </a>
                                                        </div>
                                                        <div class="cell" style="width:33%;text-align:center;padding:5px;">
                                                            <a href="terms.html" style="text-decoration:none;color:#fff;">
                                                                <div class="nav-icon" style="background:#333;border-radius:50%;width:40px;height:40px;margin:0 auto;display:flex;align-items:center;justify-content:center;cursor:pointer;">
                                                                    <span style="font-size:16px;color:#fff;font-weight:bold;">?</span>
                                                                </div>
                                                                <div style="font-size:10px;margin-top:5px;">Help</div>
                                                            </a>
                                                        </div>
                                                        <div class="cell" style="width:33%;text-align:center;padding:5px;">
                                                            <a href="index.html" style="text-decoration:none;color:#fff;">
                                                                <div class="nav-icon" style="background:#333;border-radius:50%;width:40px;height:40px;margin:0 auto;display:flex;align-items:center;justify-content:center;cursor:pointer;">
                                                                    <span style="font-size:18px;color:#fff;font-weight:bold;">H</span>
                                                                </div>
                                                                <div style="font-size:10px;margin-top:5px;">Home</div>
                                                            </a>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Action Buttons (6%) - AT BOTTOM -->
                                        <div class="row" style="width:100%;height:6%">
                                            <div class="cell">
                                                <div class="table" style="width:100%;height:100%">
                                                    <div class="row" style="width:100%;height:50%">
                                                        <div class="cell rightBtn" style="padding:.2rem .8rem .05rem .45rem;">
                                                            <div class="butcontainer">
                                                                <div class="butlayout">
                                                                    <button id="GetaChat" class="butcontent mainButtons" onclick="getChat()" style="font-size: .85rem; padding: 10px 14px; cursor: pointer; background: #95a5a6 !important; border: none; color: white; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; border-radius: 5px; font-weight: bold;" onmouseover="console.log('Get Chat hover');this.style.setProperty('background', '#7f8c8d', 'important')" onmouseout="console.log('Get Chat unhover');this.style.setProperty('background', '#95a5a6', 'important')" onmousedown="console.log('Get Chat mousedown');this.style.setProperty('background', '#6c7b7d', 'important')" onmouseup="console.log('Get Chat mouseup');this.style.setProperty('background', '#7f8c8d', 'important')">Get a Chat Box</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row" style="width:100%;height:50%">
                                                        <div class="cell rightBtn" style="padding:.05rem .8rem .2rem .45rem;">
                                                            <div class="butcontainer">
                                                                <div class="butlayout">
                                                                    <button id="signIn" class="butcontent mainButtons" onclick="signIn()" style="font-size: .85rem; padding: 10px 14px; cursor: pointer; background: #95a5a6 !important; border: none; color: white; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; border-radius: 5px; font-weight: bold;" onmouseover="console.log('Sign In hover');this.style.setProperty('background', '#7f8c8d', 'important')" onmouseout="console.log('Sign In unhover');this.style.setProperty('background', '#95a5a6', 'important')" onmousedown="console.log('Sign In mousedown');this.style.setProperty('background', '#6c7b7d', 'important')" onmouseup="console.log('Sign In mouseup');this.style.setProperty('background', '#7f8c8d', 'important')">Sign In</button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div> <!-- Close chatContainer -->
    </div> <!-- Close background -->

    <!-- Remove duplicate overlays - they're already in the main structure -->

    <script>
        // IMMEDIATE TEST - Run before DOM is ready
        console.log('üö® [IMMEDIATE] Script loaded, testing immediate visibility...');
        
        // Test if we can see the test messages
        setTimeout(() => {
            console.log('üö® [IMMEDIATE] Testing immediate content visibility...');
            const testMessage = document.querySelector('#messages li');
            const testVisitors = document.querySelector('#idvisitors li');
            
            console.log('üö® [IMMEDIATE] Test message found:', testMessage);
            console.log('üö® [IMMEDIATE] Test visitors found:', testVisitors);
            
            if (testMessage) {
                console.log('üö® [IMMEDIATE] Test message content:', testMessage.textContent);
                console.log('üö® [IMMEDIATE] Test message style:', testMessage.style.cssText);
                console.log('üö® [IMMEDIATE] Test message computed style:', window.getComputedStyle(testMessage).display);
            }
            
            if (testVisitors) {
                console.log('üö® [IMMEDIATE] Test visitors content:', testVisitors.textContent);
                console.log('üö® [IMMEDIATE] Test visitors style:', testVisitors.style.cssText);
                console.log('üö® [IMMEDIATE] Test visitors computed style:', window.getComputedStyle(testVisitors).display);
            }
        }, 100);
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéØ [CHAT] DOM loaded, setting up interface...');
            
            try {
                console.log('üîß [CHAT] Initializing systems...');
                initializeSystems();
                
                console.log('üîß [CHAT] Setting up tabs...');
                setupTabs();
                
                console.log('üîß [CHAT] Setting up chat...');
                setupChat();
                
                console.log('üîß [CHAT] Testing tabs...');
                testTabs();
                
                console.log('üîß [CHAT] Testing content visibility...');
                testContentVisibility();
                
                console.log('‚úÖ [CHAT] Interface setup complete!');
                
                // Initialize chat for authenticated user
                const storedUser = localStorage.getItem('user');
                if (storedUser) {
                    try {
                        currentUser = JSON.parse(storedUser);
                        console.log('üîê [CHAT] Found stored user:', currentUser.username);
                        initializeChat();
                    } catch (error) {
                        console.error('üîê [CHAT] Error parsing stored user:', error);
                        localStorage.removeItem('user');
                    }
                }
                
            } catch (error) {
                console.error('‚ùå [CHAT] Error during setup:', error);
            }
        });

        // ============================================================================
        // IXAT RANKING SYSTEM
        // ============================================================================
        
        function getIXatRankName(f) {
            switch(f) {
                case 0: return 'Guest';
                case 1: return 'Main Owner';
                case 2: return 'Moderator';
                case 3: return 'Member';
                case 4: return 'VIP';
                case 5: return 'Guest';
                default: return 'User';
            }
        }
        
        function getIXatRankColor(f) {
            switch(f) {
                case 0: return '#95a5a6'; // Guest
                case 1: return '#e74c3c'; // Main Owner - Red
                case 2: return '#f39c12'; // Moderator - Orange
                case 3: return '#3498db'; // Member - Blue
                case 4: return '#9b59b6'; // VIP - Purple
                case 5: return '#95a5a6'; // Guest
                default: return '#95a5a6';
            }
        }
        
        function getIXatRank(f) {
            return {
                name: getIXatRankName(f),
                color: getIXatRankColor(f),
                level: f
            };
        }
        
        function initializeSystems() {
            if (typeof CompleteSystemManager !== 'undefined') {
                const systemManager = new CompleteSystemManager();
                systemManager.initialize();
            }
        }

        function setupTabs() {
            const defaultList = document.getElementById('defaultList');
            const friendsList = document.getElementById('friendsList');
            
            if (!defaultList || !friendsList) {
                console.error('Tab elements not found!');
                return;
            }
            
            defaultList.addEventListener('click', function() {
                console.log('Visitors tab clicked');
                showVisitors();
                // Update button styles with !important
                defaultList.style.setProperty('background', '#95a5a6', 'important');
                friendsList.style.setProperty('background', '#7f8c8d', 'important');
                defaultList.classList.add('active');
                friendsList.classList.remove('active');
            });
            
            friendsList.addEventListener('click', function() {
                console.log('Friends tab clicked');
                showFriends();
                // Update button styles with !important
                friendsList.style.setProperty('background', '#95a5a6', 'important');
                defaultList.style.setProperty('background', '#7f8c8d', 'important');
                friendsList.classList.add('active');
                defaultList.classList.remove('active');
            });
        }

        function setupChat() {
            const textEntry = document.getElementById('textEntryEditable');
            const returnBut = document.getElementById('returnBut');
            
            if (textEntry && returnBut) {
                textEntry.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
                
                returnBut.addEventListener('click', function() {
                    sendMessage();
                });
            }
        }
        
        function initializeChat() {
            console.log('üé≠ [CHAT] Initializing chat system...');
            
            // Load initial data
            loadUsersList();
            loadUserPowers();
            
            // Update UI for authenticated user
            updateUserInterface();
            
            console.log('üé≠ [CHAT] Chat system initialized successfully');
        }
        
        function updateUserInterface() {
            if (!currentUser) return;
            
            // Update button text based on login status
            const signButton = document.getElementById('signIn');
            if (signButton) {
                signButton.textContent = 'Sign Out';
                signButton.onclick = () => signOut();
            }
            
            // Update Get Chat button if user owns a chat
            const getChatButton = document.getElementById('GetaChat');
            if (getChatButton && currentChat && currentChat.createdBy === currentUser.id) {
                getChatButton.textContent = 'Edit Chat';
                getChatButton.onclick = () => editChat();
            }
        }
        
        function signIn() {
            // Redirect to auth page
            window.location.href = '/auth.html';
        }
        
        function signOut() {
            localStorage.removeItem('user');
            localStorage.removeItem('authToken');
            currentUser = null;
            location.reload();
        }
        
        function getChat() {
            if (!currentUser) {
                alert('You must be signed in to get a chat');
                return;
            }
            // Show chat creation form
            showChatCreationForm();
        }
        
        function editChat() {
            if (!currentUser || !currentChat) return;
            // Redirect to chat edit page
            window.location.href = `/chat-edit.html?id=${currentChat.id}`;
        }
        
        function showChatCreationForm() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ecf0f1;">Create New Chat</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:#e74c3c;font-size:24px;cursor:pointer;">√ó</button>
                    </div>
                    
                    <form onsubmit="createNewChat(event)">
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Chat Name:</label>
                            <input type="text" id="chatName" required style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Description:</label>
                            <textarea id="chatDescription" rows="3" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;resize:vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Privacy:</label>
                            <select id="chatPrivacy" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                                <option value="invite">Invite Only</option>
                            </select>
                        </div>
                        
                        <div style="text-align:center;margin-top:20px;">
                            <button type="submit" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;">Create Chat</button>
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#7f8c8d;color:white;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function createNewChat(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('chatName').value,
                description: document.getElementById('chatDescription').value,
                privacy: document.getElementById('chatPrivacy').value,
                createdBy: currentUser.id
            };
            
            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Chat created successfully!');
                    document.querySelector('[onclick*="remove()"]').click();
                } else {
                    alert('Failed to create chat: ' + data.message);
                }
            } catch (error) {
                console.error('Error creating chat:', error);
                alert('Error creating chat');
            }
        }

        function sendMessage() {
            const textEntry = document.getElementById('textEntryEditable');
            const messages = document.getElementById('messages');
            
            if (textEntry && messages && textEntry.textContent.trim()) {
                const messageLi = document.createElement('li');
                messageLi.className = 'message';
                
                const now = new Date();
                const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                messageLi.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span class="message">${textEntry.textContent}</span>
                        <span style="font-size: 10px; color: #999; margin-left: 10px;">${timeString}</span>
                    </div>
                `;
                
                messages.appendChild(messageLi);
                textEntry.textContent = '';
                messages.scrollTop = messages.scrollHeight;
            }
        }

        function showVisitors() {
            console.log('üîß [VISITORS] Showing visitors...');
            
            const visitorsContainer = document.getElementById('visitorsContainer');
            console.log('üîç [VISITORS] visitorsContainer:', visitorsContainer);
            
            if (!visitorsContainer) {
                console.error('‚ùå [VISITORS] Visitors container not found!');
                return;
            }
            
            console.log('‚úÖ [VISITORS] Visitors container found, loading visitors...');
            
            // Load real visitors from the chat
            loadUsersList();
        }

        function showFriends() {
            console.log('üîß [FRIENDS] Showing friends...');
            
            const visitorsContainer = document.getElementById('visitorsContainer');
            console.log('üîç [FRIENDS] visitorsContainer:', visitorsContainer);
            
            if (!visitorsContainer) {
                console.error('‚ùå [FRIENDS] Visitors container not found!');
                return;
            }
            
            console.log('‚úÖ [FRIENDS] Visitors container found, loading friends...');
            
            // Load friends from the database
            loadFriendsList();
        }

        function loadDemoVisitors() {
            console.log('üîß [DEMO] Loading demo visitors...');
            
            const visitorsContainer = document.getElementById('visitorsContainer');
            console.log('üîç [DEMO] visitorsContainer:', visitorsContainer);
            
            if (visitorsContainer) {
                console.log('‚úÖ [DEMO] Container found, setting demo content...');
                visitorsContainer.innerHTML = `
                    <div style="padding: 15px; text-align: center; color: #666;">
                        <div style="font-size: 16px; margin-bottom: 8px;">üë•</div>
                        <div style="font-size: 14px; margin-bottom: 5px;">No visitors yet</div>
                        <div style="font-size: 11px; color: #888;">Be the first to join!</div>
                    </div>
                `;
                console.log('‚úÖ [DEMO] Demo content set successfully');
            } else {
                console.error('‚ùå [DEMO] Visitors container not found!');
            }
        }

        function testTabs() {
            console.log('Testing tabs...');
            const defaultList = document.getElementById('defaultList');
            const friendsList = document.getElementById('friendsList');
            const listtabs = document.getElementById('listtabs');
            
            console.log('defaultList:', defaultList);
            console.log('friendsList:', friendsList);
            console.log('listtabs:', listtabs);
            
            if (defaultList && friendsList && listtabs) {
                console.log('All tab elements found!');
            } else {
                console.error('Some tab elements missing!');
            }
        }

        function testContentVisibility() {
            console.log('Testing content visibility...');
            const messagesContainer = document.getElementById('messagesContainer');
            const messagesOverlay = document.getElementById('messagesOverlay');
            const messagesSuperContainer = document.getElementById('messagesSuperContainer');
            const messagesTabContainer = document.getElementById('messagesTabContainer');
            const visitorsContainer = document.getElementById('visitorsContainer');
            const visitorsOverlay = document.getElementById('visitorsOverlay');
            const visitorsTabContainer = document.getElementById('visitorsTabContainer');
            const listtabs = document.getElementById('listtabs');
            const smileyBar = document.getElementById('smileyBar');
            const textEntryEditable = document.getElementById('textEntryEditable');
            const returnBut = document.getElementById('returnBut');

            console.log('messagesContainer:', messagesContainer);
            console.log('messagesOverlay:', messagesOverlay);
            console.log('messagesSuperContainer:', messagesSuperContainer);
            console.log('messagesTabContainer:', messagesTabContainer);
            console.log('visitorsContainer:', visitorsContainer);
            console.log('visitorsOverlay:', visitorsOverlay);
            console.log('visitorsTabContainer:', visitorsTabContainer);
            console.log('listtabs:', listtabs);
            console.log('smileyBar:', smileyBar);
            console.log('textEntryEditable:', textEntryEditable);
            console.log('returnBut:', returnBut);

            if (messagesContainer && messagesOverlay && messagesSuperContainer && messagesTabContainer && visitorsContainer && visitorsOverlay && visitorsTabContainer && listtabs && smileyBar && textEntryEditable && returnBut) {
                console.log('All critical content elements found and visible.');
            } else {
                console.error('Some critical content elements missing or not visible.');
                console.error('messagesContainer:', !!messagesContainer);
                console.error('messagesOverlay:', !!messagesOverlay);
                console.error('messagesSuperContainer:', !!messagesSuperContainer);
                console.error('messagesTabContainer:', !!messagesTabContainer);
                console.error('visitorsContainer:', !!visitorsContainer);
                console.error('visitorsOverlay:', !!visitorsOverlay);
                console.error('visitorsTabContainer:', !!visitorsTabContainer);
                console.error('listtabs:', !!listtabs);
                console.error('smileyBar:', !!smileyBar);
                console.error('textEntryEditable:', !!textEntryEditable);
                console.error('returnBut:', !!returnBut);
            }
        }



        // Initialize friend system
        if (typeof friendSystem === 'undefined') {
            window.friendSystem = {
                friends: [],
                
                loadFriends: function() {
                    const token = localStorage.getItem('authToken');
                    if (token) {
                        fetch('/api/users/friends', {
                            headers: {
                                'Authorization': `Bearer ${token}`,
                                'Content-Type': 'application/json'
                            }
                        })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else if (response.status === 403) {
                                console.log('Auth required, showing no friends message');
                                showFriends();
                                return null;
                            }
                            throw new Error('Failed to load friends');
                        })
                        .then(data => {
                            if (data && data.friends) {
                                this.friends = data.friends;
                                this.updateFriendsDisplay();
                            }
                        })
                        .catch(error => {
                            console.error('Error loading friends:', error);
                            showFriends();
                        });
                    } else {
                        showFriends();
                    }
                },
                
                updateFriendsDisplay: function() {
                    const container = document.getElementById('visitorsContainer');
                    if (container && this.friends.length > 0) {
                        container.innerHTML = this.friends.map(friend => 
                            `<div style="padding: 8px 12px; border-bottom: 1px solid rgba(255,255,255,.1);">
                                <div style="font-weight: bold;">${friend.name}</div>
                                <div style="font-size: 12px; color: #999;">${friend.status || 'online'}</div>
                            </div>`
                        ).join('');
                    } else if (container) {
                        showFriends();
                    }
                }
            };
        }

        // Add emoji functionality
        document.querySelectorAll('.emoticon').forEach(emoji => {
            emoji.addEventListener('click', () => {
                const textEntry = document.getElementById('textEntryEditable');
                if (textEntry) {
                    textEntry.textContent += emoji.textContent;
                    textEntry.focus();
                }
            });
        });

        // Add Get a Chat Box functionality
        document.getElementById('GetaChat').addEventListener('click', function() {
            alert('Get a Chat Box functionality - This would open a modal to create a new chat room');
        });

        // Add navigation icon functionality
        document.getElementById('groupBut').addEventListener('click', function() {
            window.location.href = 'groups.html';
        });

        document.getElementById('helpBut').addEventListener('click', function() {
            window.location.href = 'terms.html';
        });

        document.getElementById('xatBut').addEventListener('click', function() {
            window.location.href = 'index.html';
        });

        // Listen for authentication messages from parent
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'AUTH_UPDATE') {
                console.log('üé≠ [CHAT] Received auth update:', event.data);
                
                if (event.data.token) {
                    localStorage.setItem('authToken', event.data.token);
                    // Now that we have a token, get user info and initialize chat
                    fetchUserInfo(event.data.token);
                }
                
                if (typeof visitorSystem !== 'undefined' && visitorSystem.loadVisitors) {
                    visitorSystem.loadVisitors();
                }
            }
        });



        // ============================================================================
        // CORE CHAT FUNCTIONS
        // ============================================================================
        
        function initializeChat() {
            console.log('üé≠ [CHAT] Initializing chat system...');
            
            // Initialize socket connection
            initializeSocket();
            
            // Setup event listeners
            setupEventListeners();
            
            // Load initial data
            loadUsersList();
            loadUserPowers();
            
            // Check chat ownership and update UI
            checkChatOwnership();
            
            // Show welcome message
            addSystemMessage(`Welcome to ${currentChat.name}!`);
            addSystemMessage('Type your message below and press Enter to chat.');
            
            console.log('üé≠ [CHAT] Chat system initialized successfully');
        }
        
        function loadUserData() {
            if (!currentUser) return;
            
            // Update UI with user info
            const userInfoElement = document.getElementById('userInfo');
            if (userInfoElement) {
                userInfoElement.innerHTML = `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <div style="width:32px;height:32px;background:${getUserAvatarColor(currentUser.username)};border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;">
                            ${currentUser.username.charAt(0).toUpperCase()}
                        </div>
                        <div>
                            <div style="font-weight:bold;color:#ecf0f1;">${currentUser.username}</div>
                            <div style="font-size:12px;color:#95a5a6;">${currentUser.rank || 'User'} | ${currentUser.xats || 0} xats</div>
                        </div>
                    </div>
                `;
            }
        }
        
        function showLoginForm() {
            // Redirect to your REAL auth system
            window.location.href = '/auth.html';
        }
        
        // ============================================================================
        // REAL CHAT OWNERSHIP SYSTEM
        // ============================================================================
        
        function checkChatOwnership() {
            if (!currentUser || !currentChat) return;
            
            // Check if current user owns this chat
            const isOwner = currentChat.createdBy === currentUser.id;
            
            // Update UI based on ownership
            updateChatOwnershipUI(isOwner);
        }
        
        function updateChatOwnershipUI(isOwner) {
            // Find the "Get a Chat Box" button and change it to "Edit Chat" if owner
            const getChatButton = document.getElementById('GetaChat');
            if (getChatButton) {
                if (isOwner) {
                    getChatButton.textContent = 'Edit Chat';
                    getChatButton.onclick = () => editChat();
                } else {
                    getChatButton.textContent = 'Get a Chat Box';
                    getChatButton.onclick = () => getChat();
                }
            }
            
            // Update sign in/out button based on login status
            const signButton = document.getElementById('signIn');
            if (signButton) {
                if (currentUser) {
                    signButton.textContent = 'Sign Out';
                    signButton.onclick = () => signOut();
                } else {
                    signButton.textContent = 'Sign In';
                    signButton.onclick = () => signIn();
                }
            }
        }
        
        function editChat() {
            if (!currentUser || !currentChat) return;
            
            // Redirect to chat edit page
            window.location.href = `/chat-edit.html?id=${currentChat.id}`;
        }
        
        function getChat() {
            console.log('üé≠ [CHAT] Get Chat button clicked!');
            if (!currentUser) {
                alert('You must be signed in to get a chat');
                return;
            }
            
            // Show chat creation form
            showChatCreationForm();
        }
        
        function showChatCreationForm() {
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ecf0f1;">Create New Chat</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:#e74c3c;font-size:24px;cursor:pointer;">√ó</button>
                    </div>
                    
                    <form onsubmit="createNewChat(event)">
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Chat Name:</label>
                            <input type="text" id="chatName" required style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Description:</label>
                            <textarea id="chatDescription" rows="3" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;resize:vertical;"></textarea>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Privacy:</label>
                            <select id="chatPrivacy" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                                <option value="public">Public</option>
                                <option value="private">Private</option>
                                <option value="invite">Invite Only</option>
                            </select>
                        </div>
                        
                        <div style="text-align:center;margin-top:20px;">
                            <button type="submit" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;">Create Chat</button>
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#7f8c8d;color:white;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function createNewChat(event) {
            event.preventDefault();
            
            const formData = {
                name: document.getElementById('chatName').value,
                description: document.getElementById('chatDescription').value,
                privacy: document.getElementById('chatPrivacy').value,
                createdBy: currentUser.id
            };
            
            try {
                const response = await fetch('/api/chats', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = response.json();
                
                if (data.success) {
                    alert('Chat created successfully!');
                    // Close modal
                    document.querySelector('.modal').remove();
                    // Redirect to new chat
                    window.location.href = `/chat.html?id=${data.chat._id}`;
                } else {
                    alert('Failed to create chat: ' + data.message);
                }
            } catch (error) {
                console.error('Chat creation error:', error);
                alert('Failed to create chat. Please try again.');
            }
        }
        
        function signIn() {
            console.log('üé≠ [AUTH] Sign In button clicked!');
            window.location.href = '/auth.html';
        }
        
        function signOut() {
            console.log('üé≠ [AUTH] Signing out user...');
            localStorage.removeItem('user');
            localStorage.removeItem('authToken');
            currentUser = null;
            location.reload();
        }
        

        
        // ============================================================================
        // REAL USER PROFILE SYSTEM
        // ============================================================================
        
        function showOwnProfile(user) {
            // Show profile editor for own profile
            const modal = document.createElement('div');
            modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;';
            
            modal.innerHTML = `
                <div style="background:#2c3e50;padding:30px;border-radius:10px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                        <h2 style="margin:0;color:#ecf0f1;">Edit Your Profile</h2>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background:none;border:none;color:#e74c3c;font-size:24px;cursor:pointer;">√ó</button>
                    </div>
                    
                    <form onsubmit="updateProfile(event)">
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Username:</label>
                                <input type="text" id="editUsername" value="${user.username}" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                            </div>
                            <div>
                                <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Nickname:</label>
                                <input type="text" id="editNickname" value="${user.nickname || ''}" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                            </div>
                        </div>
                        
                        <div style="margin-bottom:20px;">
                            <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Description:</label>
                            <textarea id="editDesc" rows="3" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;resize:vertical;">${user.desc || ''}</textarea>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
                            <div>
                                <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Avatar ID:</label>
                                <input type="number" id="editAvatar" value="${user.avatar || 0}" min="0" max="1759" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                            </div>
                            <div>
                                <label style="color:#ecf0f1;display:block;margin-bottom:5px;">Custom Pawn Color:</label>
                                <input type="color" id="editCustpawn" value="#${user.custpawn || 'FFFFFF'}" style="width:100%;padding:8px;border:1px solid #34495e;border-radius:5px;background:#34495e;color:white;">
                            </div>
                        </div>
                        
                        <div style="text-align:center;margin-top:20px;">
                            <button type="submit" style="padding:10px 20px;background:#27ae60;color:white;border:none;border-radius:5px;cursor:pointer;margin-right:10px;">Save Changes</button>
                            <button type="button" onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:10px 20px;background:#7f8c8d;color:white;border:none;border-radius:5px;cursor:pointer;">Cancel</button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        async function updateProfile(event) {
            event.preventDefault();
            
            const formData = {
                username: document.getElementById('editUsername').value,
                nickname: document.getElementById('editNickname').value,
                desc: document.getElementById('editDesc').value,
                avatar: parseInt(document.getElementById('editAvatar').value),
                custpawn: document.getElementById('editCustpawn').value.replace('#', '')
            };
            
            try {
                const response = await fetch('/api/users/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Profile updated successfully!');
                    // Update local user data
                    Object.assign(currentUser, formData);
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    // Close modal and refresh
                    document.querySelector('.modal').remove();
                    loadUserData();
                } else {
                    alert('Failed to update profile: ' + data.message);
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Failed to update profile. Please try again.');
            }
        }
        
        // ============================================================================
        // MODERATION FUNCTIONS
        // ============================================================================

        async function loadUserModerationData(userId) {
            try {
                const response = await fetch(`/api/moderation/status/${userId}/${currentChat._id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update warning count
                    const warningCountEl = document.getElementById(`warningCount-${userId}`);
                    if (warningCountEl) {
                        warningCountEl.textContent = data.warningCount;
                        warningCountEl.style.color = data.warningCount > 0 ? '#f39c12' : '#27ae60';
                    }
                    
                    // Update mute status
                    const muteStatusEl = document.getElementById(`muteStatus-${userId}`);
                    if (muteStatusEl) {
                        if (data.muteStatus) {
                            muteStatusEl.textContent = `Muted (${data.muteStatus.remainingTime} min)`;
                            muteStatusEl.style.color = '#e67e22';
                        } else {
                            muteStatusEl.textContent = 'Not muted';
                            muteStatusEl.style.color = '#27ae60';
                        }
                    }
                    
                    // Update ban status
                    const banStatusEl = document.getElementById(`banStatus-${userId}`);
                    if (banStatusEl) {
                        if (data.banStatus) {
                            banStatusEl.textContent = `Banned (${data.banStatus.remainingTime} min)`;
                            banStatusEl.style.color = '#c0392b';
                        } else {
                            banStatusEl.textContent = 'Not banned';
                            banStatusEl.style.color = '#27ae60';
                        }
                    }
                }
                
                // Load moderation history
                await loadModerationHistory(userId);
                
            } catch (error) {
                console.error('Failed to load moderation data:', error);
            }
        }

        async function loadModerationHistory(userId) {
            try {
                const response = await fetch(`/api/moderation/history/${userId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const historyContainer = document.getElementById(`modHistory-${userId}`);
                    
                    if (historyContainer && data.history.length > 0) {
                        historyContainer.innerHTML = data.history.map(action => `
                            <div style="padding:8px;margin-bottom:5px;background:#2c3e50;border-radius:3px;border-left:3px solid ${getActionColor(action.actionType)};">
                                <div style="font-size:12px;color:#ecf0f1;">
                                    <strong>${action.actionType.toUpperCase()}</strong> - ${action.reason}
                                </div>
                                <div style="font-size:10px;color:#95a5a6;">
                                    by ${action.moderator.username} on ${new Date(action.createdAt).toLocaleDateString()}
                                </div>
                            </div>
                        `).join('');
                    } else if (historyContainer) {
                        historyContainer.innerHTML = '<p style="text-align:center;color:#95a5a6;">No moderation history</p>';
                    }
                }
            } catch (error) {
                console.error('Failed to load moderation history:', error);
            }
        }

        function getActionColor(actionType) {
            const colors = {
                'warning': '#f39c12',
                'mute': '#e67e22',
                'kick': '#e74c3c',
                'ban': '#c0392b',
                'unban': '#27ae60',
                'unmute': '#27ae60'
            };
            return colors[actionType] || '#95a5a6';
        }

        async function issueWarning(userId) {
            const reason = prompt('Enter warning reason:');
            if (!reason) return;
            
            try {
                const response = await fetch('/api/moderation/warn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        targetUserId: userId,
                        chatRoomId: currentChat._id,
                        reason: reason
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`Warning issued successfully! ${data.escalation ? `Auto-escalation: ${data.escalation}` : ''}`);
                    loadUserModerationData(userId);
                } else {
                    const error = await response.json();
                    alert('Failed to issue warning: ' + error.message);
                }
            } catch (error) {
                console.error('Warning error:', error);
                alert('Failed to issue warning');
            }
        }

        async function muteUser(userId) {
            const reason = prompt('Enter mute reason:');
            if (!reason) return;
            
            const duration = prompt('Enter mute duration in minutes (or leave empty for default 15 min):');
            const muteDuration = duration ? parseInt(duration) : null;
            
            try {
                const response = await fetch('/api/moderation/mute', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        targetUserId: userId,
                        chatRoomId: currentChat._id,
                        reason: reason,
                        duration: muteDuration
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`User muted successfully for ${data.duration || 15} minutes!`);
                    loadUserModerationData(userId);
                } else {
                    const error = await response.json();
                    alert('Failed to mute user: ' + error.message);
                }
            } catch (error) {
                console.error('Mute error:', error);
                alert('Failed to mute user');
            }
        }

        async function banUser(userId) {
            const reason = prompt('Enter ban reason:');
            if (!reason) return;
            
            const duration = prompt('Enter ban duration in minutes (or leave empty for default 24 hours):');
            const banDuration = duration ? parseInt(duration) : null;
            
            try {
                const response = await fetch('/api/moderation/ban', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        targetUserId: userId,
                        chatRoomId: currentChat._id,
                        reason: reason,
                        duration: banDuration
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(`User banned successfully for ${data.duration || 1440} minutes!`);
                    loadUserModerationData(userId);
                } else {
                    const error = await response.json();
                    alert('Failed to ban user: ' + error.message);
                }
            } catch (error) {
                console.error('Ban error:', error);
                alert('Failed to ban user');
            }
        }

        // Enhanced kick function with reason
        async function kickUser(username) {
            const reason = prompt('Enter kick reason:');
            if (!reason) return;
            
            try {
                const response = await fetch('/api/moderation/kick', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({
                        targetUserId: username,
                        chatRoomId: currentChat._id,
                        reason: reason
                    })
                });
                
                if (response.ok) {
                    alert(`${username} has been kicked successfully!`);
                    loadUsersList();
                } else {
                    const error = await response.json();
                    alert('Failed to kick user: ' + error.message);
                }
            } catch (error) {
                console.error('Kick error:', error);
                alert('Failed to kick user');
            }
        }
    </script>
</body>
</html>